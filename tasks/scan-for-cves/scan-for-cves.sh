#!/usr/bin/env bash

set -eox pipefail

bom_name="bosh-release-repo.sbom"

#SYFT SCAN
syft packages \
    --output=cyclonedx-json \
    --file=$bom_name \
    dir:bosh-release-repo/
  
#GRYPE SCAN
if [[ -z "$GRYPE_FAILURE_LEVEL" ]] || [[ $GRYPE_FAILURE_LEVEL == "none" ]]
then
    # No fail mode
    grype  -o template \
        -t concourse-cve-scan/assets/template \
        --add-cpes-if-none \
        --by-cve \
        sbom:$bom_name
else
    # Grype will 'exit 1' if cve meets/exceeds level
    grype  -o template \
        -t concourse-cve-scan/assets/template \
        --add-cpes-if-none \
        --fail-on $GRYPE_FAILURE_LEVEL \
        --by-cve \
        sbom:$bom_name
fi

exit 0